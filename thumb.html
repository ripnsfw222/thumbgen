<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üé¨ Gerador de Thumbnails de V√≠deo PRO</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<style>
/* üé® Estilos Globais */
:root {
    --primary-color: #1a73e8; /* Azul Google */
    --secondary-color: #34a853; /* Verde */
    --background-color: #f8f9fa; /* Fundo claro */
    --card-background: #ffffff;
    --text-color: #202124;
    --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.1);
    --danger-color: #e81a30; /* Vermelho para Parar/Limpar */
}

body {
    font-family: 'Roboto', sans-serif;
    padding: 20px;
    background: var(--background-color);
    color: var(--text-color);
    line-height: 1.6;
    /* Adiciona margem para que o conte√∫do n√£o fique escondido sob o menu fixo */
    margin-top: 100px; 
}

h1 {
    color: var(--primary-color);
    font-weight: 700;
    font-size: 2em;
    margin-bottom: 20px;
    border-bottom: 3px solid var(--secondary-color);
    padding-bottom: 10px;
    display: inline-block;
}

/* ‚öôÔ∏è Controles Fixos */
.controls-container {
    /* NOVO: Div para conter os controles e fix√°-los */
    position: sticky; 
    top: 0;
    z-index: 1000;
    background: var(--background-color); /* Garante que o fundo n√£o seja transparente */
    padding: 10px 0;
    margin: -20px -20px 20px -20px; /* Estende para as bordas do padding do body */
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.controls {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    align-items: center;
    margin-bottom: 0;
    padding: 15px 20px; /* Padding interno */
    background: var(--card-background);
    border-radius: 0; /* Remove border-radius para sticky, ou manter arredondado */
    box-shadow: none; /* Remove a sombra neste container se a sombra for no container fixo */
    border-bottom: 1px solid #ddd;
}

.action-buttons {
    margin-left: auto; /* Empurra os bot√µes para a direita */
    display: flex;
    gap: 10px;
}

/* üñºÔ∏è Input de Arquivo */
#videoInput {
    padding: 10px;
    border: 2px solid var(--primary-color);
    border-radius: 8px;
    cursor: pointer;
    font-size: 1em;
}

/* ‚è±Ô∏è Input de Intervalo */
.input-group {
    display: flex;
    align-items: center;
    gap: 5px;
}

#intervalInput {
    width: 60px;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 8px;
    text-align: center;
}

/* üîé Filtros */
label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
    cursor: pointer;
}

input[type="checkbox"] {
    appearance: none;
    width: 18px;
    height: 18px;
    border: 2px solid var(--primary-color);
    border-radius: 4px;
    cursor: pointer;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
}

input[type="checkbox"]:checked {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

input[type="checkbox"]:checked::after {
    content: "\f00c"; /* √çcone de check do Font Awesome */
    font-family: "Font Awesome 6 Free";
    font-weight: 900;
    font-size: 12px;
    color: white;
}

/* üí° Status */
#status {
    margin: 20px 0;
    padding: 15px;
    background: #e6f0ff;
    border: 1px solid #cce0ff;
    border-left: 5px solid var(--primary-color);
    border-radius: 8px;
    font-weight: 500;
}

/* üèûÔ∏è Thumbnails Grid: Altera√ß√£o para 2 colunas */
#thumbnails {
    display: grid;
    /* Define 2 colunas de largura igual, ideal para desktop/tablet */
    grid-template-columns: 1fr 1fr; 
    gap: 20px;
    margin-top: 20px;
}

.thumb-card {
    background: var(--card-background);
    padding: 15px;
    border-radius: 12px;
    text-align: center;
    box-shadow: var(--shadow-light);
    transition: transform 0.2s, box-shadow 0.2s;
}

.thumb-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
}

.thumb-card img {
    width: 100%;
    aspect-ratio: 16 / 9; /* Propor√ß√£o padr√£o de v√≠deo */
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 10px;
    border: 1px solid #eee;
}

/* üíæ Bot√£o Padr√£o */
button {
    background-color: var(--secondary-color);
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1em;
    font-weight: 500;
    transition: background-color 0.2s, opacity 0.3s;
}

button:hover:not(:disabled) {
    background-color: #2c8c46; /* Verde mais escuro */
}

/* Bot√µes de A√ß√£o */
#stopProcessing {
    background-color: var(--danger-color);
}
#stopProcessing:hover:not(:disabled) {
    background-color: #b81427;
}

#clearResults {
    background-color: #6c757d; /* Cinza */
}
#clearResults:hover:not(:disabled) {
    background-color: #5a6268;
}

button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}


/* üì± Responsividade */

@media (max-width: 768px) {
    .controls {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
    }
    .action-buttons {
        margin-left: 0;
        width: 100%;
        justify-content: space-around;
    }
    .action-buttons button {
        flex-grow: 1;
    }
    #thumbnails {
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }
}

@media (max-width: 600px) {
    body {
        padding: 10px;
        margin-top: 150px; /* Aumenta margem superior para menus menores/quebrados */
    }
    .controls {
        padding: 10px;
    }
    #thumbnails {
        grid-template-columns: 1fr;
    }
    .action-buttons button {
        font-size: 0.9em;
        padding: 8px 15px;
    }
}
</style>
</head>
<body>

<h1><i class="fas fa-magic"></i> Gerador de Thumbnails Inteligente</h1>

<div class="controls-container">
    <div class="controls">
        <div class="input-group">
            <i class="fas fa-video fa-lg" style="color: var(--primary-color);"></i>
            <input type="file" id="videoInput" accept="video/*" title="Selecione o arquivo de v√≠deo">
        </div>
        
        <div class="input-group">
            <i class="fas fa-clock" style="color: var(--primary-color);"></i>
            <label for="intervalInput">Intervalo (s):</label>
            <input type="number" id="intervalInput" value="15" min="1" title="Intervalo de captura em segundos">
        </div>

        <label title="Apenas frames onde um rosto √© detectado">
            <input type="checkbox" id="faceFilter" checked> 
            <i class="fas fa-user"></i> Rosto Detectado
        </label>
        
        <label title="Apenas frames onde os olhos est√£o abertos">
            <input type="checkbox" id="eyesOpenFilter" checked> 
            <i class="fas fa-eye"></i> Olhos Abertos
        </label>

        <div class="action-buttons">
            <button id="stopProcessing" disabled><i class="fas fa-stop"></i> Parar</button>
            <button id="clearResults"><i class="fas fa-trash-alt"></i> Limpar Tudo</button>
        </div>
    </div>
</div>

<div id="status">Carregando modelos de IA...</div>
<div id="thumbnails"></div>

<script>
const videoInput = document.getElementById("videoInput");
const intervalInput = document.getElementById("intervalInput");
const faceFilter = document.getElementById("faceFilter");
const eyesOpenFilter = document.getElementById("eyesOpenFilter");
const thumbsDiv = document.getElementById("thumbnails");
const status = document.getElementById("status");
const stopButton = document.getElementById("stopProcessing");
const clearButton = document.getElementById("clearResults");

// Vari√°veis de controle de processo
let stopFlag = false;
let isProcessing = false;

const EYE_OPEN_THRESHOLD = 0.25; 
let modelsLoaded = false;

// Configura√ß√£o do detector para SSD Mobilenet V1 (mais preciso)
const faceDetectionOptions = new faceapi.SsdMobilenetv1Options({ 
    minConfidence: 0.5
});

// Resolu√ß√µes alvo para 720p
const RES_720P_LANDSCAPE = { width: 1280, height: 720 }; // 16:9
const RES_720P_PORTRAIT = { width: 720, height: 1280 }; // 9:16 (Inverso)

// Fun√ß√µes de A√ß√£o ------------------------------------------------------------------

function enableControls(enable) {
    videoInput.disabled = !enable;
    intervalInput.disabled = !enable;
    faceFilter.disabled = !enable;
    eyesOpenFilter.disabled = !enable;
}

function updateButtons(processing) {
    isProcessing = processing;
    stopButton.disabled = !processing;
    clearButton.disabled = processing;
    enableControls(!processing);
}

stopButton.addEventListener('click', () => {
    stopFlag = true;
    stopButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Parando...';
    stopButton.disabled = true;
});

clearButton.addEventListener('click', () => {
    clearResults();
});

function clearResults() {
    thumbsDiv.innerHTML = '';
    status.innerHTML = modelsLoaded ? 
        '<i class="fas fa-check-circle" style="color:var(--secondary-color)"></i> Pronto para selecionar um novo v√≠deo.' : 
        '<i class="fas fa-hourglass-half fa-spin"></i> Carregando modelos...';
    // Remove o arquivo do input para permitir o upload do mesmo arquivo novamente
    videoInput.value = '';
    updateButtons(false);
}

// ----------------------------------------------------------------------------------


// Fun√ß√µes Auxiliares (mantidas)
async function loadModels() {
    const MODEL_URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights/';
    try {
        status.innerHTML = '<i class="fas fa-hourglass-half fa-spin"></i> Carregando modelos...';
        await faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL); 
        await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
        modelsLoaded = true;
        status.innerHTML = '<i class="fas fa-check-circle" style="color:var(--secondary-color)"></i> Modelos carregados! Selecione um v√≠deo para come√ßar.';
    } catch(err) {
        status.innerHTML = '<i class="fas fa-exclamation-triangle" style="color:red"></i> Erro ao carregar modelos. Recarregue a p√°gina.';
        console.error(err);
    }
}
loadModels();

function seekVideo(video, time){
    return new Promise(resolve=>{
        video.currentTime = time;
        if(video.requestVideoFrameCallback){
            video.requestVideoFrameCallback(()=>resolve());
        } else {
            video.addEventListener('seeked', resolve, {once:true});
        }
    });
}

function downloadImage(dataURL, filename){
    const a = document.createElement('a');
    a.href = dataURL;
    a.download = filename;
    a.click();
}

function eyeOpenRatio(eye){
    const vertical1 = distance(eye[1], eye[5]);
    const vertical2 = distance(eye[2], eye[4]);
    const horizontal = distance(eye[0], eye[3]);
    return (vertical1 + vertical2) / (2 * horizontal + 1e-6); 
}

function distance(p1,p2){
    return Math.hypot(p1.x-p2.x, p1.y-p2.y);
}

function resizeCanvas(originalCanvas, videoWidth, videoHeight) {
    const aspectRatio = videoWidth / videoHeight;
    let targetWidth, targetHeight;
    
    if (aspectRatio > 1) { 
        targetWidth = RES_720P_LANDSCAPE.width;
        targetHeight = RES_720P_LANDSCAPE.height;
    } else { 
        targetWidth = RES_720P_PORTRAIT.width;
        targetHeight = RES_720P_PORTRAIT.height;
    }

    const resizedCanvas = document.createElement("canvas");
    resizedCanvas.width = targetWidth;
    resizedCanvas.height = targetHeight;
    const ctx = resizedCanvas.getContext("2d");
    
    ctx.drawImage(originalCanvas, 0, 0, targetWidth, targetHeight);
    
    return resizedCanvas;
}


// Processamento Principal ----------------------------------------------------------

videoInput.addEventListener("change", async ()=>{
    thumbsDiv.innerHTML = '';
    const file = videoInput.files[0];
    if(!file) return;
    if(!modelsLoaded){
        alert("Aguarde os modelos de IA carregarem antes de enviar o v√≠deo!");
        return;
    }

    // Inicializa o processo
    stopFlag = false;
    updateButtons(true);
    stopButton.innerHTML = '<i class="fas fa-stop"></i> Parar';

    const url = URL.createObjectURL(file);
    const video = document.createElement("video");
    video.src = url;
    video.muted = true;
    video.preload = "metadata";
    video.style.display = 'none'; 

    document.body.appendChild(video); 

    await new Promise(resolve => video.addEventListener('loadedmetadata', resolve, {once:true}));
    const duration = video.duration;
    const interval = parseInt(intervalInput.value) || 15;
    const filterFace = faceFilter.checked;
    const filterEyes = eyesOpenFilter.checked;
    
    const videoWidth = video.videoWidth;
    const videoHeight = video.videoHeight;

    status.innerHTML = `<i class="fas fa-cogs fa-spin"></i> Processando frames...`;

    let generated = 0;
    let totalFrames = Math.ceil(duration/interval);
    let framesProcessed = 0;

    for(let t=0; t<duration; t+=interval){
        // NOVO: Verifica a flag de parada em cada itera√ß√£o
        if(stopFlag) {
            status.innerHTML = `<i class="fas fa-times-circle" style="color:var(--danger-color)"></i> Processamento interrompido pelo usu√°rio. **${generated}** thumbnails geradas.`;
            break;
        }

        await seekVideo(video,t);

        const originalCanvas = document.createElement("canvas");
        originalCanvas.width = videoWidth;
        originalCanvas.height = videoHeight;
        const ctx = originalCanvas.getContext("2d");
        ctx.drawImage(video,0,0,originalCanvas.width,originalCanvas.height);

        let passFilters = true;
        if(filterFace || filterEyes){
            const detections = await faceapi.detectAllFaces(originalCanvas, faceDetectionOptions).withFaceLandmarks();
            
            if(filterFace && detections.length===0) passFilters=false;
            
            if(filterEyes && detections.length>0 && passFilters){
                for(const det of detections){
                    const leftEye = det.landmarks.getLeftEye();
                    const rightEye = det.landmarks.getRightEye();
                    const ratioL = eyeOpenRatio(leftEye);
                    const ratioR = eyeOpenRatio(rightEye);

                    if(ratioL < EYE_OPEN_THRESHOLD || ratioR < EYE_OPEN_THRESHOLD){
                        passFilters=false;
                        break; 
                    }
                }
            }
        }

        if(passFilters){
            const finalCanvas = resizeCanvas(originalCanvas, videoWidth, videoHeight);
            const dataURL = finalCanvas.toDataURL("image/jpeg",0.95);
            
            const card = document.createElement("div");
            card.className="thumb-card";
            const img = document.createElement("img"); 
            img.src=dataURL;
            if (finalCanvas.width > finalCanvas.height) {
                 img.style.aspectRatio = '16 / 9';
            } else {
                 img.style.aspectRatio = '9 / 16';
            }
            
            const btn = document.createElement("button");
            btn.innerHTML = `<i class="fas fa-download"></i> Salvar 720p frame ${Math.floor(t)}s`;
            btn.onclick = ()=>downloadImage(dataURL, `thumb_720p_${Math.floor(t)}s.jpg`);
            
            card.appendChild(img); 
            card.appendChild(btn);
            thumbsDiv.appendChild(card);
            generated++;
        }
        
        framesProcessed++;
        status.innerHTML = `<i class="fas fa-cogs fa-spin"></i> Processando frames... (${framesProcessed}/${totalFrames}) | Geradas: **${generated}**`;
        await new Promise(r=>setTimeout(r,10)); 
    }

    if (!stopFlag) {
        status.innerHTML = generated > 0 ? 
            `<i class="fas fa-check-circle" style="color:var(--secondary-color)"></i> Processamento conclu√≠do! **${generated}** thumbnails 720p geradas.` : 
            '<i class="fas fa-exclamation-triangle" style="color:red"></i> Nenhuma thumbnail gerada. Tente desativar os filtros ou aumentar o intervalo.';
    }
    
    // Finaliza o processo
    updateButtons(false);
    URL.revokeObjectURL(url);
    video.remove();
});
</script>

</body>
</html>
